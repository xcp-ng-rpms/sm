From d06273542c24f697149d936dc411b686a4aeb2a4 Mon Sep 17 00:00:00 2001
From: Damien Thenot <damien.thenot@vates.tech>
Date: Fri, 14 Mar 2025 10:04:46 +0100
Subject: [PATCH] Limit setParent when QCOW is opened

It should only be done by tapdisk commit process.

Signed-off-by: Damien Thenot <damien.thenot@vates.tech>
---
 drivers/qcow2util.py | 15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/drivers/qcow2util.py b/drivers/qcow2util.py
index 1bea5a04..38871108 100644
--- a/drivers/qcow2util.py
+++ b/drivers/qcow2util.py
@@ -575,11 +575,16 @@ class QCowUtil(CowUtil):
 
     @override
     def setParent(self, path: str, parentPath: str, parentRaw: bool) -> None:
-        parentType = QCOW2_TYPE
-        if parentRaw:
-            parentType = RAW_TYPE
-        cmd = [QEMU_IMG, "rebase", "-u", "-f", QCOW2_TYPE, "-F", parentType, "-b", parentPath, path]
-        self._ioretry(cmd)
+        pid_openers = util.get_openers_pid(path)
+        if not pid_openers:
+            parentType = QCOW2_TYPE
+            if parentRaw:
+                parentType = RAW_TYPE
+            cmd = [QEMU_IMG, "rebase", "-u", "-f", QCOW2_TYPE, "-F", parentType, "-b", parentPath, path]
+            self._ioretry(cmd)
+        else:
+            util.SMlog("Could not rebase because openers {}".format(pid_openers))
+            # Maybe check the parent is already the correct one thanks to tapdisk coalesce
 
     @override
     def getHidden(self, path: str) -> bool:
