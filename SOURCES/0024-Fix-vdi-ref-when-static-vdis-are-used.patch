From 943677ab9173541505aedbb0ec8667cca6c1bfe4 Mon Sep 17 00:00:00 2001
From: Guillaume <guillaume.thouvenin@vates.tech>
Date: Wed, 16 Aug 2023 13:42:21 +0200
Subject: [PATCH 24/24] Fix vdi-ref when static vdis are used

When static vdis are used there is no snapshots and we don't want to
call method from XAPI.
Upstream PR: https://github.com/xapi-project/sm/pull/631

Signed-off-by: Guillaume <guillaume.thouvenin@vates.tech>
---
 drivers/LVHDSR.py | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/drivers/LVHDSR.py b/drivers/LVHDSR.py
index 94d1d45..9791c59 100755
--- a/drivers/LVHDSR.py
+++ b/drivers/LVHDSR.py
@@ -1510,10 +1510,11 @@ class LVHDVDI(VDI.VDI):
         elif self.sr.provision == "thick":
             needDeflate = False
             # except for snapshots, which are always deflated
-            vdi_ref = self.sr.srcmd.params['vdi_ref']
-            snap = self.session.xenapi.VDI.get_is_a_snapshot(vdi_ref)
-            if snap:
-                needDeflate = True
+            if self.sr.srcmd.cmd != 'vdi_detach_from_config':
+                vdi_ref = self.sr.srcmd.params['vdi_ref']
+                snap = self.session.xenapi.VDI.get_is_a_snapshot(vdi_ref)
+                if snap:
+                    needDeflate = True
 
         if needDeflate:
             try:
-- 
2.41.0

