From 36dc495fb24764c5e1b7f4de379efc5568b105f0 Mon Sep 17 00:00:00 2001
From: Ronan Abhamon <ronan.abhamon@vates.fr>
Date: Tue, 6 Jun 2023 11:50:54 +0200
Subject: [PATCH 122/176] fix(blktap2): ensure we can import this module when
 LINSTOR is not installed

Signed-off-by: Ronan Abhamon <ronan.abhamon@vates.fr>
---
 drivers/blktap2.py | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/blktap2.py b/drivers/blktap2.py
index 370f7fb..fd7c643 100755
--- a/drivers/blktap2.py
+++ b/drivers/blktap2.py
@@ -36,7 +36,6 @@ import json
 import xs_errors
 import XenAPI
 import scsiutil
-from linstorvolumemanager import log_drbd_openers
 from syslog import openlog, syslog
 from stat import * # S_ISBLK(), ...
 import nfs
@@ -51,6 +50,12 @@ from xmlrpclib import ServerProxy, Transport
 from socket import socket, AF_UNIX, SOCK_STREAM
 from httplib import HTTP, HTTPConnection
 
+try:
+    from linstorvolumemanager import log_drbd_openers
+    LINSTOR_AVAILABLE = True
+except ImportError:
+    LINSTOR_AVAILABLE = False
+
 PLUGIN_TAP_PAUSE = "tapdisk-pause"
 
 SOCKPATH = "/var/xapi/xcp-rrdd"
@@ -832,7 +837,7 @@ class Tapdisk(object):
                                     retry_open += 1
                                     time.sleep(1)
                                     continue
-                                if err == errno.EROFS:
+                                if LINSTOR_AVAILABLE and err == errno.EROFS:
                                     log_drbd_openers(path)
                             raise
                     try:
-- 
2.45.2

