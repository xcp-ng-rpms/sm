From 25481c2568d4e5d6a15a4b1ffee16d8c5c168150 Mon Sep 17 00:00:00 2001
From: ben sims <ben.sims@citrix.com>
Date: Thu, 12 Dec 2019 11:21:39 +0000
Subject: [PATCH] CA-332806 - Fix type mismatch when processing speed file

Signed-off-by: ben sims <ben.sims@citrix.com>
---
 drivers/cleanup.py    | 8 +++++++-
 tests/test_cleanup.py | 4 ++++
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/drivers/cleanup.py b/drivers/cleanup.py
index 73a66d9b..a1d71d74 100755
--- a/drivers/cleanup.py
+++ b/drivers/cleanup.py
@@ -1948,7 +1948,13 @@ def getStorageSpeed(self):
             if os.path.isfile(path):
                 speedFile = open(path)
                 content = speedFile.readlines()
-                content = [float(i) for i in content]
+                try:
+                    content = [float(i) for i in content]
+                except exceptions.ValueError:
+                    Util.log("Something bad in the speed log:{log}".
+                             format(log=speedFile.readlines()))
+                    return speed
+
                 if len(content):
                     speed = sum(content)/float(len(content))
                     if speed <= 0:
diff --git a/tests/test_cleanup.py b/tests/test_cleanup.py
index dc64a73b..d4182ca1 100644
--- a/tests/test_cleanup.py
+++ b/tests/test_cleanup.py
@@ -967,6 +967,10 @@ def test_getStorageSpeed(self, mock_chmod, mock_isFile, mock_open):
         self.getStorageSpeed(mock_isFile, sr, fakeFile, True, 3.0, 1,
                              lines=[1.0, 2.0, 6.0])
 
+        # File exists contains, a string
+        self.getStorageSpeed(mock_isFile, sr, fakeFile, True, None, 1,
+                             lines=[1.0, 2.0, "Hello"])
+
     def speedFileSetup(self, sr, FakeFile, mock_isFile, isFile):
         expectedPath = cleanup.SPEED_LOG_ROOT.format(uuid=sr.uuid)
         mock_isFile.return_value = isFile
