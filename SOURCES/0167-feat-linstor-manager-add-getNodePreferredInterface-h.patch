From 99997af6173a0bd6ed59a0242657f162245aef91 Mon Sep 17 00:00:00 2001
From: Ronan Abhamon <ronan.abhamon@vates.fr>
Date: Mon, 15 Apr 2024 11:22:18 +0200
Subject: [PATCH 167/180] feat(linstor-manager): add
 `getNodePreferredInterface` helper

Signed-off-by: Ronan Abhamon <ronan.abhamon@vates.fr>
---
 drivers/linstor-manager         | 16 ++++++++++++++++
 drivers/linstorvolumemanager.py | 17 +++++++++++++++++
 2 files changed, 33 insertions(+)

diff --git a/drivers/linstor-manager b/drivers/linstor-manager
index 6b45875..a2501d7 100755
--- a/drivers/linstor-manager
+++ b/drivers/linstor-manager
@@ -1062,6 +1062,21 @@ def list_node_interfaces(session, args):
         raise XenAPIPlugin.Failure('-1', [str(e)])
 
 
+def get_node_preferred_interface(session, args):
+    group_name = args['groupName']
+    hostname = args['hostname']
+
+    linstor = LinstorVolumeManager(
+        get_controller_uri(),
+        group_name,
+        logger=util.SMlog
+    )
+    try:
+        return linstor.get_node_preferred_interface(hostname)
+    except Exception as e:
+        raise XenAPIPlugin.Failure('-1', [str(e)])
+
+
 def set_node_preferred_interface(session, args):
     group_name = args['groupName']
     hostname = args['hostname']
@@ -1132,5 +1147,6 @@ if __name__ == '__main__':
         'destroyNodeInterface': destroy_node_interface,
         'modifyNodeInterface': modify_node_interface,
         'listNodeInterfaces': list_node_interfaces,
+        'getNodePreferredInterface': get_node_preferred_interface,
         'setNodePreferredInterface': set_node_preferred_interface
     })
diff --git a/drivers/linstorvolumemanager.py b/drivers/linstorvolumemanager.py
index 4118a28..46c3283 100755
--- a/drivers/linstorvolumemanager.py
+++ b/drivers/linstorvolumemanager.py
@@ -1544,6 +1544,23 @@ class LinstorVolumeManager(object):
             }
         return interfaces
 
+    def get_node_preferred_interface(self, node_name):
+        """
+        Get the preferred interface used by a node.
+        :param str node_name: Node name of the interface to get.
+        :rtype: str
+        """
+        try:
+            nodes = self._linstor.node_list_raise([node_name]).nodes
+            if nodes:
+                properties = nodes[0].props
+                return properties.get('PrefNic', 'default')
+            return nodes
+        except Exception as e:
+            raise LinstorVolumeManagerError(
+                'Failed to get preferred interface: `{}`'.format(e)
+            )
+
     def set_node_preferred_interface(self, node_name, name):
         """
         Set the preferred interface to use on a node.
-- 
2.46.0

