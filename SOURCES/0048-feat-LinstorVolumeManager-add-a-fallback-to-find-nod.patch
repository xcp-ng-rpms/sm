From 53850ec1f126a68485c20d01a81da2529ba19d90 Mon Sep 17 00:00:00 2001
From: Ronan Abhamon <ronan.abhamon@vates.fr>
Date: Thu, 21 Oct 2021 11:51:32 +0200
Subject: [PATCH 048/179] feat(LinstorVolumeManager): add a fallback to find
 node name (when len(hosts) >= 4)

Signed-off-by: Ronan Abhamon <ronan.abhamon@vates.fr>
---
 drivers/linstorvolumemanager.py | 21 ++++++++++++++-------
 1 file changed, 14 insertions(+), 7 deletions(-)

diff --git a/drivers/linstorvolumemanager.py b/drivers/linstorvolumemanager.py
index 821ef42..e497afa 100755
--- a/drivers/linstorvolumemanager.py
+++ b/drivers/linstorvolumemanager.py
@@ -210,19 +210,26 @@ def get_controller_uri():
 
 
 def get_controller_node_name():
+    PLUGIN_CMD = 'hasControllerRunning'
+
     (ret, stdout, stderr) = util.doexec([
         'drbdadm', 'status', DATABASE_VOLUME_NAME
     ])
-    if ret != 0:
-        return
 
-    if stdout.startswith('{} role:Primary'.format(DATABASE_VOLUME_NAME)):
-        return 'localhost'
+    if ret == 0:
+        if stdout.startswith('{} role:Primary'.format(DATABASE_VOLUME_NAME)):
+            return 'localhost'
 
-    res = REG_DRBDADM_PRIMARY.search(stdout)
-    if res:
-        return res.groups()[0]
+        res = REG_DRBDADM_PRIMARY.search(stdout)
+        if res:
+            return res.groups()[0]
 
+    session = util.get_localAPI_session()
+    for host_ref, host_record in session.xenapi.host.get_all_records().items():
+        if distutils.util.strtobool(
+            session.xenapi.host.call_plugin(host_ref, PLUGIN, PLUGIN_CMD, {})
+        ):
+            return host_record['hostname']
 
 # ==============================================================================
 
-- 
2.46.0

