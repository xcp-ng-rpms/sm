From a61f57754d0dc4f7e0d6a9f461820ae46b8f8305 Mon Sep 17 00:00:00 2001
From: Ronan Abhamon <ronan.abhamon@vates.tech>
Date: Wed, 8 Oct 2025 22:14:30 +0200
Subject: [PATCH] feat(LinstorSR): prohibit QCOW2

Signed-off-by: Ronan Abhamon <ronan.abhamon@vates.tech>
---
 drivers/LinstorSR.py | 4 ++--
 drivers/SR.py        | 4 ++--
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/LinstorSR.py b/drivers/LinstorSR.py
index 558c1ca8..b4285de3 100755
--- a/drivers/LinstorSR.py
+++ b/drivers/LinstorSR.py
@@ -57,7 +57,7 @@ import xml.etree.ElementTree as xml_parser
 import xmlrpc.client
 import xs_errors
 
-from cowutil import CowUtil, getImageStringFromVdiType, getVdiTypeFromImageFormat
+from cowutil import CowUtil, ImageFormat, getImageStringFromVdiType, getVdiTypeFromImageFormat
 from srmetadata import \
     NAME_LABEL_TAG, NAME_DESCRIPTION_TAG, IS_A_SNAPSHOT_TAG, SNAPSHOT_OF_TAG, \
     TYPE_TAG, VDI_TYPE_TAG, READ_ONLY_TAG, SNAPSHOT_TIME_TAG, \
@@ -319,7 +319,7 @@ class LinstorSR(SR.SR):
 
     def __init__(self, srcmd, sr_uuid):
         SR.SR.__init__(self, srcmd, sr_uuid)
-        self._init_preferred_image_formats()
+        self._init_preferred_image_formats([ImageFormat.VHD])
 
     @override
     def load(self, sr_uuid) -> None:
diff --git a/drivers/SR.py b/drivers/SR.py
index 92301f17..6806a989 100755
--- a/drivers/SR.py
+++ b/drivers/SR.py
@@ -521,10 +521,10 @@ class SR(object):
 
         return missing_keys
 
-    def _init_preferred_image_formats(self) -> None:
+    def _init_preferred_image_formats(self, default_image_formats=None) -> None:
         self.preferred_image_formats = parseImageFormats(
             self.dconf and self.dconf.get('preferred-image-formats'),
-            DEFAULT_IMAGE_FORMATS
+            default_image_formats or DEFAULT_IMAGE_FORMATS
         )
 
     def _get_snap_vdi_type(self, vdi_type: str, size: int) -> str:
