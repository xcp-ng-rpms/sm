From 620ca1abd996743be6096300df42230c23c35d9d Mon Sep 17 00:00:00 2001
From: BenjiReis <benjamin.reis@vates.tech>
Date: Mon, 27 Nov 2023 14:23:57 +0100
Subject: [PATCH 148/180] feat(linstor-kv-tool): If no controller uri option is
 provided fetch it (#48)

Signed-off-by: BenjiReis <benjamin.reis@vates.fr>
---
 scripts/linstor-kv-tool | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/scripts/linstor-kv-tool b/scripts/linstor-kv-tool
index c907027..b845ec2 100755
--- a/scripts/linstor-kv-tool
+++ b/scripts/linstor-kv-tool
@@ -13,6 +13,10 @@
 #
 # You should have received a copy of the GNU General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
+import sys
+sys.path[0] = '/opt/xensource/sm/'
+
+from linstorvolumemanager import get_controller_uri
 
 import argparse
 import json
@@ -56,7 +60,7 @@ def remove_all_volumes(controller_uri, group_name):
 
 def main():
     parser = argparse.ArgumentParser()
-    parser.add_argument('-u', '--uri', required=True)
+    parser.add_argument('-u', '--uri', required=False)
     parser.add_argument('-g', '--group-name', required=True)
     parser.add_argument('-n', '--namespace', default='/')
 
@@ -66,12 +70,14 @@ def main():
     action.add_argument('--remove-all-volumes', action='store_true')
 
     args = parser.parse_args()
+    controller_uri = get_controller_uri() if args.uri is None else args.uri
+
     if args.dump_volumes:
-        dump_kv(args.uri, args.group_name, args.namespace)
+        dump_kv(controller_uri, args.group_name, args.namespace)
     elif args.remove_volume:
-        remove_volume(args.uri, args.group_name, args.remove_volume)
+        remove_volume(controller_uri, args.group_name, args.remove_volume)
     elif args.remove_all_volumes:
-        remove_all_volumes(args.uri, args.group_name)
+        remove_all_volumes(controller_uri, args.group_name)
 
 
 if __name__ == '__main__':
-- 
2.46.0

